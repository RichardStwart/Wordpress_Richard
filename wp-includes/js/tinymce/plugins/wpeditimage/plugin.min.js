tinymce.PluginManager.add("wpeditimage",function(C){var d,y,n,s,a,e=tinymce.each,m=tinymce.trim,t=tinymce.Env.iOS;function i(e){return!(!C.dom.getAttrib(e,"data-mce-placeholder")&&!C.dom.getAttrib(e,"data-mce-object"))}function o(e){var t=C.$(e).parents("[contenteditable]");return t&&"false"===t.attr("contenteditable")}function r(e){return e.replace(/(?:<p>)?\[(?:wp_)?caption([^\]]+)\]([\s\S]+?)\[\/(?:wp_)?caption\](?:<\/p>)?/g,function(e,t,n){var a,i,o,r,c,l;return(a=t.match(/id=['"]([^'"]*)['"] ?/))&&(t=t.replace(a[0],"")),(i=t.match(/align=['"]([^'"]*)['"] ?/))&&(t=t.replace(i[0],"")),(o=t.match(/class=['"]([^'"]*)['"] ?/))&&(t=t.replace(o[0],"")),(l=t.match(/width=['"]([0-9]*)['"] ?/))&&(t=t.replace(l[0],"")),c=(c=(n=m(n)).match(/((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)([\s\S]*)/i))&&c[2]?(r=m(c[2]),m(c[1])):(r=m(t).replace(/caption=['"]/,"").replace(/['"]$/,""),n),a=a&&a[1]?a[1].replace(/[<>&]+/g,""):"",i=i&&i[1]?i[1]:"alignnone",o=o&&o[1]?" "+o[1].replace(/[<>&]+/g,""):"",!l&&c&&(l=c.match(/width=['"]([0-9]*)['"]/)),l&&l[1]&&(l=l[1]),l&&r?(l=parseInt(l,10),C.getParam("wpeditimage_html5_captions")||(l+=10),'<div class="mceTemp"><dl id="'+a+'" class="wp-caption '+i+o+'" style="width: '+l+'px"><dt class="wp-caption-dt">'+c+'</dt><dd class="wp-caption-dd">'+r+"</dd></dl></div>"):n})}function c(e){return e.replace(/(?:<div [^>]+mceTemp[^>]+>)?\s*(<dl [^>]+wp-caption[^>]+>[\s\S]+?<\/dl>)\s*(?:<\/div>)?/g,function(e,t){var n="";return-1===t.indexOf("<img ")||-1!==t.indexOf("</p>")?t.replace(/<d[ldt]( [^>]+)?>/g,"").replace(/<\/d[ldt]>/g,""):(-1===(n=t.replace(/\s*<dl ([^>]+)>\s*<dt [^>]+>([\s\S]+?)<\/dt>\s*<dd [^>]+>([\s\S]*?)<\/dd>\s*<\/dl>\s*/gi,function(e,t,n,a){var i,o,r,c;return c=(c=n.match(/width="([0-9]*)"/))&&c[1]?c[1]:"",r=(o=(o=t.match(/class="([^"]*)"/))&&o[1]?o[1]:"").match(/align[a-z]+/i)||"alignnone",c&&a?(i=(i=t.match(/id="([^"]*)"/))&&i[1]?i[1]:"",(o=o.replace(/wp-caption ?|align[a-z]+ ?/gi,""))&&(o=' class="'+o+'"'),'[caption id="'+i+'" align="'+r+'" width="'+c+'"'+o+"]"+n+" "+(a=(a=a.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")})).replace(/\s*\n\s*/g,"<br />"))+"[/caption]"):("alignnone"!==r[0]&&(n=n.replace(/><img/,' class="'+r[0]+'"><img')),n)})).indexOf("[caption")&&(n=t.replace(/[\s\S]*?((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)(<p>[\s\S]*<\/p>)?[\s\S]*/gi,"<p>$1</p>$2")),n)})}function A(e){return e&&!!(e.textContent||e.innerText).replace(/\ufeff/g,"")}function p(e){var t=C.dom.getParent(e,"div.mceTemp");t||"IMG"!==e.nodeName||(t=C.dom.getParent(e,"a")),t?(t.nextSibling?C.selection.select(t.nextSibling):t.previousSibling?C.selection.select(t.previousSibling):C.selection.select(t.parentNode),C.selection.collapse(!0),C.dom.remove(t)):C.dom.remove(e),C.nodeChanged(),C.undoManager.add()}return C.addButton("wp_img_remove",{tooltip:"Remove",icon:"dashicon dashicons-no",onclick:function(){p(C.selection.getNode())}}),C.addButton("wp_img_edit",{tooltip:"Edit|button",icon:"dashicon dashicons-edit",onclick:function(){!function(t){var n,e,a;if("undefined"==typeof wp||!wp.media)return C.execCommand("mceImage");a=function(e){var t,n,a,i,o,r,c,l,d=[],s=C.dom,m=/^\d+$/;(a={attachment_id:!1,size:"custom",caption:"",align:"none",extraClasses:"",link:!1,linkUrl:"",linkClassName:"",linkTargetBlank:!1,linkRel:"",title:""}).url=s.getAttrib(e,"src"),a.alt=s.getAttrib(e,"alt"),a.title=s.getAttrib(e,"title"),c=s.getAttrib(e,"width"),l=s.getAttrib(e,"height"),(!m.test(c)||parseInt(c,10)<1)&&(c=e.naturalWidth||e.width);(!m.test(l)||parseInt(l,10)<1)&&(l=e.naturalHeight||e.height);a.customWidth=a.width=c,a.customHeight=a.height=l,t=tinymce.explode(e.className," "),n=[],tinymce.each(t,function(e){/^wp-image/.test(e)?a.attachment_id=parseInt(e.replace("wp-image-",""),10):/^align/.test(e)?a.align=e.replace("align",""):/^size/.test(e)?a.size=e.replace("size-",""):n.push(e)}),a.extraClasses=n.join(" "),(i=s.getParents(e,".wp-caption")).length&&(i=i[0],t=i.className.split(" "),tinymce.each(t,function(e){/^align/.test(e)?a.align=e.replace("align",""):e&&"wp-caption"!==e&&d.push(e)}),a.captionClassName=d.join(" "),(o=s.select("dd.wp-caption-dd",i)).length&&(o=o[0],a.caption=C.serializer.serialize(o).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,"")));e.parentNode&&"A"===e.parentNode.nodeName&&(r=e.parentNode,a.linkUrl=s.getAttrib(r,"href"),a.linkTargetBlank="_blank"===s.getAttrib(r,"target"),a.linkRel=s.getAttrib(r,"rel"),a.linkClassName=r.className);return a}(t),wp.media.events.trigger("editor:image-edit",{editor:C,metadata:a,image:t}),n=wp.media({frame:"image",state:"image-details",metadata:a}),wp.media.events.trigger("editor:frame-create",{frame:n}),e=function(e){C.focus(),C.undoManager.transact(function(){!function(e,t){var n,a,i,o,r,c,l,d,s,m,p,g,u,f,h,w,N,v,b,_=C.dom;(n=tinymce.explode(t.extraClasses," "))||(n=[]);t.caption||n.push("align"+t.align);t.attachment_id&&(n.push("wp-image-"+t.attachment_id),t.size&&"custom"!==t.size&&n.push("size-"+t.size));f=t.width,h=t.height,"custom"===t.size&&(f=t.customWidth,h=t.customHeight);g={src:t.url,width:f||null,height:h||null,title:t.title||null,class:n.join(" ")||null},_.setAttribs(e,g),C.$(e).attr("alt",t.alt||""),u={href:t.linkUrl,rel:t.linkRel||null,target:t.linkTargetBlank?"_blank":null,class:t.linkClassName||null},e.parentNode&&"A"===e.parentNode.nodeName&&!A(e.parentNode)?t.linkUrl?_.setAttribs(e.parentNode,u):_.remove(e.parentNode,!0):t.linkUrl&&((l=_.getParent(e,"a"))&&_.insertAfter(e,l),l=_.create("a",u),e.parentNode.insertBefore(l,e),l.appendChild(e));d=C.dom.getParent(e,".mceTemp"),i=e.parentNode&&"A"===e.parentNode.nodeName&&!A(e.parentNode)?e.parentNode:e;t.caption?(t.caption=function(e){if(!e||-1===e.indexOf("<")&&-1===e.indexOf(">"))return e;y||(y=new tinymce.html.Serializer({},C.schema));return y.serialize(C.parser.parse(e,{forced_root_block:!1}))}(t.caption),p=t.attachment_id?"attachment_"+t.attachment_id:null,w="align"+(t.align||"none"),a="wp-caption "+w,t.captionClassName&&(a+=" "+t.captionClassName.replace(/[<>&]+/g,"")),C.getParam("wpeditimage_html5_captions")||(f=parseInt(f,10),f+=10),d?((m=_.select("dl.wp-caption",d)).length&&_.setAttribs(m,{id:p,class:a,style:"width: "+f+"px"}),(s=_.select(".wp-caption-dd",d)).length&&_.setHTML(s[0],t.caption)):(o="<dl "+(p=p?'id="'+p+'" ':"")+'class="'+a+'" style="width: '+f+'px"><dt class="wp-caption-dt"></dt><dd class="wp-caption-dd">'+t.caption+"</dd></dl>",c=_.create("div",{class:"mceTemp"},o),(r=_.getParent(i,"p"))?r.parentNode.insertBefore(c,r):i.parentNode.insertBefore(c,i),C.$(c).find("dt.wp-caption-dt").append(i),r&&_.isEmpty(r)&&_.remove(r))):d&&(r=_.create("p"),d.parentNode.insertBefore(r,d),r.appendChild(i),_.remove(d));N=C.$(e),v=N.attr("srcset"),b=N.attr("src"),v&&b&&(b=b.replace(/[?#].*/,""),-1===v.indexOf(b)&&N.attr("srcset",null).attr("sizes",null));wp.media.events&&wp.media.events.trigger("editor:image-update",{editor:C,metadata:t,image:e});C.nodeChanged()}(t,e)}),n.detach()},n.state("image-details").on("update",e),n.state("replace-image").on("replace",e),n.on("close",function(){C.focus(),n.detach()}),n.open()}(C.selection.getNode())}}),e({alignleft:"Align left",aligncenter:"Align center",alignright:"Align right",alignnone:"No alignment"},function(e,a){var t=a.slice(5);C.addButton("wp_img_"+a,{tooltip:e,icon:"dashicon dashicons-align-"+t,cmd:"alignnone"===a?"wpAlignNone":"Justify"+t.slice(0,1).toUpperCase()+t.slice(1),onPostRender:function(){var n=this;C.on("NodeChange",function(e){var t;"IMG"===e.element.nodeName&&(t=C.dom.getParent(e.element,".wp-caption")||e.element,"alignnone"===a?n.active(!/\balign(left|center|right)\b/.test(t.className)):n.active(C.dom.hasClass(t,a)))})}})}),C.once("preinit",function(){C.wp&&C.wp._createToolbar&&(d=C.wp._createToolbar(["wp_img_alignleft","wp_img_aligncenter","wp_img_alignright","wp_img_alignnone","wp_img_edit","wp_img_remove"]))}),C.on("wptoolbar",function(e){"IMG"!==e.element.nodeName||i(e.element)||(e.toolbar=d)}),t&&C.on("init",function(){C.on("touchstart",function(e){"IMG"!==e.target.nodeName||o(e.target)||(n=!0)}),C.dom.bind(C.getDoc(),"touchmove",function(){n=!1}),C.on("touchend",function(e){if(n&&"IMG"===e.target.nodeName&&!o(e.target)){var t=e.target;n=!1,window.setTimeout(function(){C.selection.select(t),C.nodeChanged()},100)}else d&&d.hide()})}),C.on("init",function(){var t=C.dom,e=C.getParam("wpeditimage_html5_captions")?"html5-captions":"html4-captions";t.addClass(C.getBody(),e),tinymce.Env.ie&&10<tinymce.Env.ie&&t.bind(C.getBody(),"mscontrolselect",function(e){"IMG"===e.target.nodeName&&t.getParent(e.target,".wp-caption")?C.getBody().focus():"DL"===e.target.nodeName&&t.hasClass(e.target,"wp-caption")&&e.target.focus()})}),C.on("ObjectResized",function(a){var i=a.target;"IMG"===i.nodeName&&C.undoManager.transact(function(){var e,t,n=C.dom;i.className=i.className.replace(/\bsize-[^ ]+/,""),(e=n.getParent(i,".wp-caption"))&&(t=a.width||n.getAttrib(i,"width"))&&(t=parseInt(t,10),C.getParam("wpeditimage_html5_captions")||(t+=10),n.setStyle(e,"width",t+"px"))})}),C.on("pastePostProcess",function(e){C.dom.getParent(C.selection.getNode(),"dd.wp-caption-dd")&&(C.$("img, audio, video, object, embed, iframe, script, style",e.node).remove(),C.$("*",e.node).each(function(e,t){C.dom.isBlock(t)&&(tinymce.trim(t.textContent||t.innerText)?(C.dom.insertAfter(C.dom.create("br"),t),C.dom.remove(t,!0)):C.dom.remove(t))}),C.$("br",e.node).each(function(e,t){t.nextSibling&&"BR"!==t.nextSibling.nodeName&&t.previousSibling&&"BR"!==t.previousSibling.nodeName||C.dom.remove(t)}),s=!0)}),C.on("BeforeExecCommand",function(e){var t,n,a,i,o,r,c=e.command,l=C.dom;if("mceInsertContent"===c||"Indent"===c||"Outdent"===c){if(t=C.selection.getNode(),r=l.getParent(t,"div.mceTemp")){if("mceInsertContent"!==c)return e.preventDefault(),e.stopImmediatePropagation(),!1;if(s)return void(s=!1);n=l.create("p"),l.insertAfter(n,r),C.selection.setCursorLocation(n,0),"IMG"===t.nodeName&&C.$(r).remove(),C.nodeChanged()}}else if("JustifyLeft"===c||"JustifyRight"===c||"JustifyCenter"===c||"wpAlignNone"===c){if(t=C.selection.getNode(),i="align"+c.slice(7).toLowerCase(),a=C.dom.getParent(t,".wp-caption"),"IMG"!==t.nodeName&&!a)return;t=a||t,o=C.dom.hasClass(t,i)?" alignnone":" "+i,t.className=m(t.className.replace(/ ?align(left|center|right|none)/g,"")+o),C.nodeChanged(),e.preventDefault(),d&&d.reposition(),C.fire("ExecCommand",{command:c,ui:e.ui,value:e.value})}}),C.on("keydown",function(e){var t,n,a,i,o=C.selection,r=e.keyCode,c=C.dom,l=tinymce.util.VK;if(r===l.ENTER)t=o.getNode(),(n=c.getParent(t,"div.mceTemp"))&&(c.events.cancel(e),tinymce.each(c.select("dt, dd",n),function(e){c.isEmpty(e)&&c.remove(e)}),i=tinymce.Env.ie&&tinymce.Env.ie<11?"":'<br data-mce-bogus="1" />',a=c.create("p",null,i),"DD"===t.nodeName?c.insertAfter(a,n):n.parentNode.insertBefore(a,n),C.nodeChanged(),o.setCursorLocation(a,0));else if((r===l.DELETE||r===l.BACKSPACE)&&("DIV"===(t=o.getNode()).nodeName&&c.hasClass(t,"mceTemp")?n=t:"IMG"!==t.nodeName&&"DT"!==t.nodeName&&"A"!==t.nodeName||(n=c.getParent(t,"div.mceTemp")),n))return c.events.cancel(e),p(t),!1}),tinymce.Env.gecko&&C.on("undo redo",function(){"IMG"===C.selection.getNode().nodeName&&C.selection.collapse()}),C.wpSetImgCaption=function(e){return r(e)},C.wpGetImgCaption=function(e){return c(e)},C.on("beforeGetContent",function(e){"raw"!==e.format&&C.$('img[id="__wp-temp-img-id"]').attr("id",null)}),C.on("BeforeSetContent",function(e){"raw"!==e.format&&(e.content=C.wpSetImgCaption(e.content))}),C.on("PostProcess",function(e){e.get&&(e.content=C.wpGetImgCaption(e.content))}),C.on("dragstart",function(){var e=C.selection.getNode();"IMG"===e.nodeName&&((a=C.dom.getParent(e,".mceTemp"))||"A"!==e.parentNode.nodeName||A(e.parentNode)||(a=e.parentNode))}),C.on("drop",function(e){var t=C.dom,n=tinymce.dom.RangeUtils.getCaretRangeFromPoint(e.clientX,e.clientY,C.getDoc());n&&t.getParent(n.startContainer,".mceTemp")?e.preventDefault():a&&(e.preventDefault(),C.undoManager.transact(function(){n&&C.selection.setRng(n),C.selection.setNode(a),t.remove(a)})),a=null}),C.wp=C.wp||{},C.wp.isPlaceholder=i,{_do_shcode:r,_get_shcode:c}});