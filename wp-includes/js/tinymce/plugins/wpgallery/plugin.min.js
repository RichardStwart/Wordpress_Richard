tinymce.PluginManager.add("wpgallery",function(o){function t(e){return e.replace(/\[gallery([^\]]*)\]/g,function(e){return t="wp-gallery",n=e,n=window.encodeURIComponent(n),'<img src="'+tinymce.Env.transparentSrc+'" class="wp-media mceItem '+t+'" data-wp-media="'+n+'" data-mce-resize="false" data-mce-placeholder="1" alt="" />';var t,n})}function n(e){return e.replace(/(?:<p(?: [^>]+)?>)*(<img [^>]+>)(?:<\/p>)*/g,function(e,t){var n,a,d=(n=t,a="data-wp-media",(a=new RegExp(a+'="([^"]+)"').exec(n))?window.decodeURIComponent(a[1]):"");return d?"<p>"+d+"</p>":e})}function d(n){var a,d,e;"IMG"===n.nodeName&&"undefined"!=typeof wp&&wp.media&&(e=window.decodeURIComponent(o.dom.getAttrib(n,"data-wp-media")),o.dom.hasClass(n,"wp-gallery")&&wp.media.gallery&&(a=wp.media.gallery,(d=a.edit(e)).state("gallery-edit").on("update",function(e){var t=a.shortcode(e).string();o.dom.setAttrib(n,"data-wp-media",window.encodeURIComponent(t)),d.detach()})))}o.addCommand("WP_Gallery",function(){d(o.selection.getNode())}),o.on("mouseup",function(e){var t=o.dom,n=e.target;function a(){t.removeClass(t.select("img.wp-media-selected"),"wp-media-selected")}"IMG"===n.nodeName&&t.getAttrib(n,"data-wp-media")?2!==e.button&&(t.hasClass(n,"wp-media-selected")?d(n):(a(),t.addClass(n,"wp-media-selected"))):a()}),o.on("ResolveName",function(e){var t=o.dom,n=e.target;"IMG"===n.nodeName&&t.getAttrib(n,"data-wp-media")&&t.hasClass(n,"wp-gallery")&&(e.name="gallery")}),o.on("BeforeSetContent",function(e){o.plugins.wpview&&"undefined"!=typeof wp&&wp.mce||(e.content=t(e.content))}),o.on("PostProcess",function(e){e.get&&(e.content=n(e.content))})});